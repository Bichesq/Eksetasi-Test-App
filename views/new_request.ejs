<%- include('partials/header', { title: 'Create Notification' }) %>

<div class="card">
  <div style="text-align: center; margin-bottom: 2rem;">
    <h2>Create Notification</h2>
    <p>Fill in the details below to schedule a notification.</p>
  </div>

  <% if (errors) { %>
    <div class="alert alert-error">
      <strong>Error:</strong>
      <pre><%= JSON.stringify(errors, null, 2) %></pre>
    </div>
  <% } %>

  <% if (result) { %>
    <div class="alert alert-success">
      <strong>Queued Successfully!</strong>
      <pre><%= JSON.stringify(result, null, 2) %></pre>
    </div>
  <% } %>

  <form method="POST" action="/request">

    <div class="form-group">
      <label for="Application">Application Name</label>
      <input type="text" id="Application" name="Application" value="<%= form.Application || '' %>" required placeholder="e.g. MyService" />
    </div>

    <div class="form-group">
      <label for="Recipient">Recipient ID</label>
      <input type="text" id="Recipient" name="Recipient" value="<%= form.Recipient || '' %>" required placeholder="User ID or Name" />
    </div>

    <div class="form-group">
      <label for="Subject">Subject (Optional)</label>
      <input type="text" id="Subject" name="Subject" value="<%= form.Subject || '' %>" placeholder="Notification Subject" />
    </div>

    <div class="form-group">
      <label for="Message">Message</label>
      <textarea id="Message" name="Message" required placeholder="Enter your message here..."><%= form.Message || '' %></textarea>
    </div>

    <div class="form-group">
      <label for="OutputType">Output Channel</label>
      <select id="OutputType" name="OutputType" required>
        <option value="SMS" <%= form.OutputType === 'SMS' ? 'selected' : '' %>>SMS</option>
        <option value="EMAIL" <%= form.OutputType === 'EMAIL' ? 'selected' : '' %>>EMAIL</option>
        <option value="PUSH" <%= form.OutputType === 'PUSH' ? 'selected' : '' %>>PUSH</option>
      </select>
    </div>

    <!-- Scheduling Section -->
    <div class="card" style="background-color: #F8F9FA; padding: 20px; box-shadow: none; border: 1px solid #eee;">
      <div class="checkbox-field" style="margin-bottom: 1rem;">
         <input type="checkbox" id="ScheduleNotification" name="ScheduleNotification" onchange="toggleScheduling()" />
         <label for="ScheduleNotification"><strong>Schedule Later?</strong></label>
      </div>

      <div id="SchedulingSection" style="display: none;">
          <h4 style="margin-top: 1rem;">Date & Time</h4>
          <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 140px;">
              <input type="date" id="Date" name="Date" value="<%= form.Date || '' %>" />
            </div>
            <div style="flex: 1; min-width: 140px;">
              <input type="time" id="Time" name="Time" value="<%= form.Time || '' %>" />
            </div>
          </div>
        
          <h4>Recurrence</h4>
          <div class="checkbox-field" style="margin-bottom: 1.5rem;">
            <input type="checkbox" id="Once" name="Once" <%= form.Once ? 'checked' : '' %> />
            <label for="Once">One-time only</label>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
            <div>
              <label for="Days">Days</label>
              <select id="Days" name="Days" multiple size="3">
                <% for (let i=1; i<=31; i++) { %>
                  <option value="<%= i %>"><%= i %></option>
                <% } %>
              </select>
            </div>
            <div>
              <label for="Weeks">Weeks</label>
              <select id="Weeks" name="Weeks" multiple size="3">
                <% for (let i=1; i<=52; i++) { %>
                  <option value="<%= i %>"><%= i %></option>
                <% } %>
              </select>
            </div>
            <div>
              <label for="Months">Months</label>
              <select id="Months" name="Months" multiple size="3">
                <% for (let i=1; i<=12; i++) { %>
                  <option value="<%= i %>"><%= i %></option>
                <% } %>
              </select>
            </div>
          </div>
      </div>
    </div>

    <!-- Delivery Target Section -->
    <div class="form-group" style="margin-top: 2rem;">
      <h3 style="margin-bottom: 1rem;">Delivery Details</h3>

      <div id="SMSFields" class="delivery-field" style="display:none;">
        <label for="PhoneNumber">Phone Number</label>
        <input type="text" id="PhoneNumber" name="PhoneNumber" value="<%= form.PhoneNumber || '' %>" placeholder="+1234567890" />
      </div>

      <div id="EMAILFields" class="delivery-field" style="display:none;">
        <label for="EmailAddresses">Email Addresses</label>
        <input type="text" id="EmailAddresses" name="EmailAddresses" value="<%= form.EmailAddresses || '' %>" placeholder="user@example.com, other@example.com" />
      </div>

      <div id="PUSHFields" class="delivery-field" style="display:none;">
        <label for="PushToken">Push Token</label>
        <input type="text" id="PushToken" name="PushToken" value="<%= form.PushToken || '' %>" />
      </div>
    </div>

    <button type="submit" style="margin-top: 2rem;">
        Send Notification <span>&rarr;</span>
    </button>
  </form>
</div>

<script>
    function toggleScheduling() {
        const isChecked = document.getElementById('ScheduleNotification').checked;
        document.getElementById('SchedulingSection').style.display = isChecked ? 'block' : 'none';
    }

    function updateDeliveryFields() {
        const outputType = document.getElementById('OutputType').value;
        
        // Hide all first
        document.querySelectorAll('.delivery-field').forEach(el => el.style.display = 'none');
        document.getElementById('PhoneNumber').required = false;
        document.getElementById('EmailAddresses').required = false;
        document.getElementById('PushToken').required = false;

        if (outputType === 'SMS') {
            document.getElementById('SMSFields').style.display = 'block';
            document.getElementById('PhoneNumber').required = true;
        } else if (outputType === 'EMAIL') {
            document.getElementById('EMAILFields').style.display = 'block';
            document.getElementById('EmailAddresses').required = true;
        } else if (outputType === 'PUSH') {
            document.getElementById('PUSHFields').style.display = 'block';
            document.getElementById('PushToken').required = true;
        }
    }

    // Attach listener
    document.getElementById('OutputType').addEventListener('change', updateDeliveryFields);

    // Initial run
    updateDeliveryFields();
</script>

<%- include('partials/footer') %>
